#!/bin/bash
set -euo pipefail

echo "Running pre-commit checks..."

fail() { echo "$1"; exit 1; }

(cd backend && cargo fmt --check) || fail "Backend formatting failed!"
(cd backend && cargo clippy -- -D warnings) || fail "Backend clippy failed!"
(cd frontend && npm run check) || fail "Frontend type checking failed!"
(cd frontend && npm run lint) || fail "Frontend lint failed!"
(cd backend && cargo test) || fail "Backend tests failed!"
(cd frontend && npm test) || fail "Frontend tests failed!"

echo "Running local CodeQL security scan..."
(
    # Only do a local quick scan to catch obvious security issues before pushing
    # Requires CodeQL CLI installed locally: https://github.com/github/codeql-cli-binaries
    # Analyze Rust and TypeScript sources

    # Temporary DB folder
    tmp_db=$(mktemp -d)

    # Rust
    codeql database create "$tmp_db/rust-db" --language=rust --source-root=backend
    codeql database analyze "$tmp_db/rust-db" --format=sarif-latest || fail "CodeQL Rust scan detected issues!"

    # TypeScript
    codeql database create "$tmp_db/ts-db" --language=typescript --source-root=frontend
    codeql database analyze "$tmp_db/ts-db" --format=sarif-latest || fail "CodeQL TypeScript scan detected issues!"

    rm -rf "$tmp_db"
)

echo "All checks passed!"
