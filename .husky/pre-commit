#!/bin/bash
set -euo pipefail

echo "Running pre-commit checks..."

fail() { echo "$1"; exit 1; }

(cd backend && cargo fmt --check) || fail "Backend formatting failed!"
(cd backend && cargo clippy -- -D warnings) || fail "Backend clippy failed!"
(cd frontend && npm run check) || fail "Frontend type checking failed!"
(cd frontend && npm run lint) || fail "Frontend lint failed!"
(cd backend && cargo test) || fail "Backend tests failed!"
(cd frontend && npm test) || fail "Frontend tests failed!"

# Get staged files
rust_staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)
ts_staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.ts$' || true)

if [[ -n "$rust_staged_files" || -n "$ts_staged_files" ]]; then
    echo "Running CodeQL security scan on staged files..."
    tmp_db=$(mktemp -d)

    if [[ -n "$rust_staged_files" ]]; then
        codeql database create "$tmp_db/rust-db" --language=rust --source-root=backend --files "$rust_staged_files"
        codeql database analyze "$tmp_db/rust-db" --format=sarif-latest || fail "CodeQL Rust scan detected issues!"
    fi

    if [[ -n "$ts_staged_files" ]]; then
        codeql database create "$tmp_db/ts-db" --language=typescript --source-root=frontend --files "$ts_staged_files"
        codeql database analyze "$tmp_db/ts-db" --format=sarif-latest || fail "CodeQL TypeScript scan detected issues!"
    fi

    rm -rf "$tmp_db"
else
    echo "No Rust or TypeScript files staged. Skipping CodeQL scan."
fi

echo "All checks passed!"
